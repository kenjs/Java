<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cy.driver.dao.TransactionInfoDao">
	<resultMap type="TransactionInfoDomain" id="transactionInfoDomainMap">
		<result property="id" column="ID"/>
		<result property="cargoId" column="CARGO_ID"/>
		<result property="orderNumber" column="ORDER_NUMBER"/>
		<result property="cargoType" column="CARGO_TYPE"/>
		<result property="cargoName" column="CARGO_NAME"/>
		<result property="cargoWeight" column="CARGO_WEIGHT"/>
		<result property="cargoCubage" column="CARGO_CUBAGE"/>
		<result property="contactName" column="CONTACT_NAME"/>
		<result property="contactMobilephone" column="CONTACT_MOBILEPHONE"/>
		<result property="contactTelephone" column="CONTACT_TELEPHONE"/>
		<result property="requestCarBarType" column="REQUEST_CAR_BAR_TYPE"/>
		<result property="requestCarLength" column="REQUEST_CAR_LENGTH"/>
		<result property="requestCarPlateType" column="REQUEST_CAR_PLATE_TYPE"/>
		<result property="startProvince" column="START_PROVINCE"/>
		<result property="startCity" column="START_CITY"/>
		<result property="endProvince" column="END_PROVINCE"/>
		<result property="endCity" column="END_CITY"/>
		<result property="requestStartTime" column="REQUEST_START_TIME"/>
		<result property="requestEndTime" column="REQUEST_END_TIME"/>
		<result property="freight" column="FREIGHT"/>
	</resultMap>

	<!-- 查询司机订单数量 -->
	<select id="selectDriverOrderNumber" parameterType="string" resultType="integer">
		select count(id) from t_transaction_info where ORDER_START = 0
		and DRIVER_ID = #{driverId} and TRADE_START = 1 and ORDER_TYPE = 1
	</select>

	<!-- (我的订单)订单数量 -->
	<select id="selectMyOrderNumber" parameterType="string" resultType="integer">
		select count(id) from t_transaction_info where ORDER_START = 0 and DRIVER_ID = #{driverId} and ORDER_TYPE = 1
	</select>

	<!-- 查询司机订单集合 -->
	<select id="selectDriverOrderList" parameterType="map" resultType="TransactionInfoDomain">
		SELECT
			rt.CARGO_TYPE as cargoType,
			rt.REQUEST_START_TIME as requestStartTime,
			rt.REQUEST_END_TIME as requestEndTime,
			rt.START_PROVINCE as startProvince,
			rt.START_CITY as startCity,
			rt.START_COUNTY as startCounty,
			rt.START_TOWN as startTown,
			rt.END_PROVINCE as endProvince,
			rt.END_CITY as endCity,
			rt.END_COUNTY as endCounty,
			rt.END_TOWN as endTown,
			rt.CARGO_NAME cargoName,
			rt.CONTACT_MOBILEPHONE as contactMobilephone,
			rt.CONTACT_TELEPHONE as contactTelephone,
			rt.CONTACT_NAME as contactName,
			rt.CARGO_WEIGHT as cargoWeight,
			rt.CARGO_CUBAGE as cargoCubage,
			lt.ID as id,
			lt.ORDER_NUMBER as orderNumber,
			lt.CARGO_ID as cargoId,
			lt.DEPLOY_USERID as deployUserid,
			lt.COMPANY_ID as companyId,
			lt.TRADE_START as tradeStart,
			lt.TRADE_CANCEL_ORIGIN as tradeCancelOrigin,
			(SELECT c.COMPANY_NAME FROM t_company_info c WHERE c.ID = lt.COMPANY_ID) companyName
		FROM
			t_transaction_info lt,
			t_order_cargo_info rt
		WHERE lt.CARGO_ID = rt.ID
		AND lt.ORDER_START = 0
		AND lt.TRADE_START = 1
		AND lt.DRIVER_ID = #{driverId}
		AND lt.ORDER_TYPE = 1
		order by requestStartTime desc
		limit ${fromSize},${listSize}
	</select>

	<!-- 查询司机订单详情 -->
	<select id="selectDriverOrderDetail" parameterType="string" resultType="TransactionInfoDomain">
		SELECT
			rt.CARGO_TYPE as cargoType,
			rt.REQUEST_START_TIME as requestStartTime,
			rt.REQUEST_END_TIME as requestEndTime,
			rt.START_PROVINCE as startProvince,
			rt.START_CITY as startCity,
			rt.START_COUNTY as startCounty,
			rt.START_TOWN as startTown,
			rt.END_PROVINCE as endProvince,
			rt.END_CITY as endCity,
			rt.END_COUNTY as endCounty,
			rt.END_TOWN as endTown,
			rt.CARGO_NAME cargoName,
			rt.CONTACT_MOBILEPHONE as contactMobilephone,
			rt.CONTACT_TELEPHONE as contactTelephone,
			rt.CONTACT_NAME as contactName,
			rt.CARGO_WEIGHT as cargoWeight,
			rt.CARGO_CUBAGE as cargoCubage,
			lt.ID as id,
			lt.ORDER_NUMBER as orderNumber,
			lt.DRIVER_ID as driverId,
			lt.CARGO_ID as cargoId,
			lt.DEPLOY_USERID as deployUserid,
			lt.COMPANY_ID as companyId,
			lt.TRADE_START as tradeStart,
			lt.TRADE_CANCEL_ORIGIN as tradeCancelOrigin,
			lt.SHIPPER_CODE as shipperCode,
			lt.SHIPPER_ORDER_NO as shipperOrderNo,
			lt.DELIVERY_TIME as deliveryTime,
			lt.ARRIVAL_TIME as arrivalTime,
			lt.RECEIVE_TIME as receiveTime,
			lt.RECEIVER_CODE as receiverCode,
			lt.RECEIVER_ORDER_NO as receiverOrderNo,
			lt.SHIPPER_COMPANY_CODE as shipperCompanyCode,
			lt.SHIPPER_COMPANY_ID as shipperCompanyId,
			(SELECT c.COMPANY_NAME FROM t_company_info c WHERE c.ID = lt.COMPANY_ID) companyName,
			(SELECT c.COMPANY_NAME FROM t_company_info c WHERE c.ID = lt.SHIPPER_COMPANY_ID) shipperCompanyName,
			lt.SHIPPER_CODE_ID as shipperCodeId,
			lt.RECEIVER_CODE_ID as receiverCodeId,
			(select p.COMPANY_NAME from t_company_info p where p.ID =
			(select usr.COMPANY_ID from t_web_user_info usr where usr.ID = lt.SHIPPER_CODE_ID)) shipperCodeName,
			(select p.COMPANY_NAME from t_company_info p where p.ID =
			(select usr.COMPANY_ID from t_web_user_info usr where usr.ID = lt.RECEIVER_CODE_ID)) receiverCodeName
		FROM
			t_transaction_info lt,
			t_order_cargo_info rt
		WHERE lt.CARGO_ID = rt.ID
		AND lt.ID = #{id}
	</select>

	<!-- 更改订单状态 -->
	<update id="updateTransactionInfoById" parameterType="map">
		update t_transaction_info set
        <if test="tradeStart != null and tradeStart != ''">
            TRADE_START = #{tradeStart},TRADE_START_TIME = sysdate(),
        </if>
		<if test="driverMobiphone != null and driverMobiphone != ''">
			DRIVER_MOBIPHONE = #{driverMobiphone},
		</if>
        <if test="tradeFair != null and tradeFair != ''">
            TRADE_FAIR = #{tradeFair},
        </if>
        <if test="orderStart != null and orderStart != ''">
            ORDER_START = #{orderStart},
        </if>
        <if test="remark != null and remark != ''">
            REMARK = #{remark},
        </if>
        <if test="tradeCancelOrigin != null and tradeCancelOrigin != ''">
            TRADE_CANCEL_ORIGIN = #{tradeCancelOrigin},
        </if>
        <if test="shipperCompanyCode != null and shipperCompanyCode != ''">
            SHIPPER_COMPANY_CODE = #{shipperCompanyCode},
        </if>
        <if test="driverId != null and driverId != ''">
            DRIVER_ID = #{driverId},
        </if>
        <if test="shipperCompanyId != null and shipperCompanyId != ''">
            SHIPPER_COMPANY_ID = #{shipperCompanyId},
        </if>
		<if test="driverVerifyTime != null and driverVerifyTime != ''">
			driver_verify_time = #{driverVerifyTime},
		</if>
		MODIFY_TIME = sysdate()
		where ID = #{id}
	</update>

	<!-- 已经成交的货源 -->
	<select id="selectDoneCargoList" parameterType="map" resultMap="transactionInfoDomainMap">
		SELECT
			t1.ID,
			t1.CARGO_ID,
			t1.ORDER_NUMBER,
			t2.CARGO_TYPE,
			t2.CARGO_NAME,
			t2.CARGO_WEIGHT,
			t2.CARGO_CUBAGE,
			t2.CONTACT_NAME,
			t2.CONTACT_MOBILEPHONE,
			t2.CONTACT_TELEPHONE,
			t2.REQUEST_CAR_BAR_TYPE,
			t2.REQUEST_CAR_LENGTH,
			t2.REQUEST_CAR_PLATE_TYPE,
			t2.START_PROVINCE,
			t2.START_CITY,
			t2.START_COUNTY as startCounty,
			t2.START_TOWN as startTown,
			t2.END_PROVINCE,
			t2.END_CITY,
			t2.END_COUNTY as endCounty,
			t2.END_TOWN as endTown,
			t2.REQUEST_START_TIME,
			t2.REQUEST_END_TIME,
			t2.FREIGHT
		FROM
			t_transaction_info t1,
			t_order_cargo_info t2
		WHERE
			t1.CARGO_ID = t2.ID
		AND t1.TRADE_START = 5
		AND t1.DRIVER_ID = #{driverId}
		AND t2.DELETED_FLAG = 0
		AND t1.ORDER_TYPE = 1
		order by t2.REQUEST_START_TIME desc
		limit ${fromSize},${listSize}
	</select>

    <!-- 新增交易状态历史 -->
    <insert id="addTransactionLastInfo" parameterType="TransactionLastInfoBo" useGeneratedKeys="true" keyProperty="id">
        insert into t_transaction_last_info (CARGO_ID,DRIVER_ID,TRANSACTION_ID,START,REMARK,CREATE_TIME)
        select t.CARGO_ID,t.DRIVER_ID,t.ID,t.TRADE_START,t.REMARK,sysdate() from t_transaction_info t where t.ID = #{transactionId}
    </insert>

	<!-- 根据id查找订单状态 -->
	<select id="selectTransactionStartById" parameterType="string" resultType="java.util.HashMap">
		select IFNULL(t.TRADE_START,-1) tradeStart,IFNULL(t.TRADE_CANCEL_ORIGIN,-1) tradeCancelOrigin from t_transaction_info t where t.ID = #{id}	</select>

	<!-- 根据司机手机号码查找订单数量 -->
	<select id="selectTransactionInfoByDriverMobiphone" parameterType="string" resultMap="transactionInfoDomainMap">
		select * from t_transaction_info where TRADE_START = 9 and ORDER_START = 0 and ORDER_TYPE = 2 and DRIVER_MOBIPHONE = #{driverMobiphone}
	</select>

	<!--                    查询导入的订单信息                                                -->

	<!-- 根据 ‘发货单号’查询订单信息 -->
	<select id="selectTransactionByShipperOrderNo" parameterType="map" resultType="TransactionInfoDomain">
		select
			t.ID as id,
			t.ORDER_NUMBER as orderNumber,
			t.DRIVER_ID as driverId,
			(select d.`NAME` from t_driver_user_info d where d.ID = t.DRIVER_ID) driverName,
			t.DEPLOY_USERID as deployUserid,
			(select w.`NAME` from t_web_user_info w where w.ID = t.DEPLOY_USERID) deployUserName,
			t.COMPANY_ID as companyId,
			(select p.COMPANY_NAME from t_company_info p where p.ID = t.COMPANY_ID) companyName,
			t.TRADE_START as tradeStart,
			t.REMARK as remark,
			t.SHIPPER_CODE as shipperCode,
			t.SHIPPER_ORDER_NO as shipperOrderNo,
			t.DELIVERY_TIME as deliveryTime,
			t.ARRIVAL_TIME as arrivalTime,
			t.RECEIVE_TIME as receiveTime,
			t.RECEIVER_CODE as receiverCode,
			t.RECEIVER_ORDER_NO as receiverOrderNo,
			t.SHIPPER_COMPANY_CODE as shipperCompanyCode,
			t.SHIPPER_COMPANY_ID as shipperCompanyId,
			(select p.COMPANY_NAME from t_company_info p where p.ID = t.SHIPPER_COMPANY_ID) shipperCompanyName,
			t.SHIPPER_CODE_ID as shipperCodeId,
			(select p.COMPANY_NAME from t_company_info p where p.ID =
			(select usr.COMPANY_ID from t_web_user_info usr where usr.ID = t.SHIPPER_CODE_ID)) shipperCodeName,
			t.RECEIVER_CODE_ID as receiverCodeId,
			(select p.COMPANY_NAME from t_company_info p where p.ID =
			(select usr.COMPANY_ID from t_web_user_info usr where usr.ID = t.RECEIVER_CODE_ID)) receiverCodeName,
			c.START_PROVINCE as startProvince,
			c.START_CITY as startCity,
			c.END_PROVINCE as endProvince,
			c.END_CITY as endCity
		from t_transaction_info t,t_order_cargo_info c
		where t.CARGO_ID = c.ID  and t.ORDER_START = 0
		and t.TRADE_START = 0
		and t.ORDER_TYPE = 2
		and t.SHIPPER_ORDER_NO = #{shipperOrderNo}
		ORDER BY t.ORDER_NUMBER ASC limit ${fromSize},${listSize}
	</select>

	<!-- 查询待确认的货单数目 -->
	<select id="queryWaitingConfirmReceiptNum" parameterType="string" resultType="integer">
		SELECT COUNT(t.ID) FROM t_transaction_info t WHERE
		t.ORDER_START = 0 AND t.TRADE_START = 1 AND t.ORDER_TYPE = 2 AND t.DRIVER_ID = #{driverId}
	</select>

    <!-- 查找物流公司id -->
    <select id="selectShipperCompanyId" parameterType="map" resultType="WebUserInfoDomain">
        SELECT
        t.ID as id,
        t.PARENT_ID as parentId,
        t.MOBILEPHONE as mobilephone,
        t.NAME as name,
        c.CONTACT_NAME as contactName,
        c.CONTACT_TELEPHONE contactTelephone
        FROM
        t_web_user_info t,t_company_info c
        WHERE
        t.DELETED_FLAG = 0
        and t.FREEZE_FLAG = 0
        and t.COMPANY_ID = c.ID
        and t.PARENT_ID = #{deployUserId} and t.ENCODED = #{shipperCompanyCode}
    </select>

	<select id="queryTransactionGroupByCompany" parameterType="string" resultType="TransactionInfoDomain">
		SELECT
			count(t.id) quantity,
			t.company_id companyId,
			(select w.company_name from t_company_info w where w.id = t.company_id) companyName
		FROM
			t_transaction_info t
		WHERE
			t.order_type = 2
			AND t.order_start = 0
			AND t.trade_start = 1
			AND t.driver_id = #{driverId}
		GROUP BY t.company_id
		ORDER BY t.company_id desc
	</select>

	<select id="queryGroupDetail" parameterType="hashmap" resultMap="transactionInfoDomainMap">
		SELECT
			t.ID as id,
			t.CARGO_ID as cargoId,
			t.COMPANY_ID as companyId,
			t.CREATE_TIME as createTime,
			t.DEPLOY_USERID as deployUserid,
			t.DRIVER_ID as driverId,
			t.MODIFY_TIME as modifyTime,
			t.ORDER_NUMBER as orderNumber,
			t.REMARK as remark,
			t.TRADE_FAIR as tradeFair,
			t.TRADE_START as tradeStart,
			t.TRADE_CANCEL_ORIGIN as tradeCancelOrigin,
			t.SHIPPER_ORDER_NO as shipperOrderNo,
			t.RECEIVER_ORDER_NO as receiverOrderNo,
			t2.CARGO_TYPE as cargoType,
			t2.CARGO_NAME as cargoName,
			t2.CARGO_WEIGHT as cargoWeight,
			t2.CARGO_CUBAGE as cargoCubage,
			t2.CONTACT_NAME as contactName,
			t2.CONTACT_MOBILEPHONE as contactMobilephone,
			t2.CONTACT_TELEPHONE as contactTelephone,
			t2.REQUEST_CAR_BAR_TYPE as requestCarBarType,
			t2.REQUEST_CAR_LENGTH as requestCarLength,
			t2.REQUEST_CAR_PLATE_TYPE as requestCarPlateType,
			t2.START_PROVINCE as startProvince,
			t2.START_CITY as startCity,
			t2.START_COUNTY as startCounty,
			t2.START_TOWN as startTown,
			t2.END_PROVINCE as endProvince,
			t2.END_CITY as endCity,
			t2.END_COUNTY as endCounty,
			t2.END_TOWN as endTown,
			t2.REQUEST_START_TIME as requestStartTime,
			t2.REQUEST_END_TIME as requestEndTime,
			t2.FREIGHT as freight,
			t.TRADE_START_TIME as tradeStartTime,
			(select count(r.ID) from t_transaction_receipt_path r where r.TRANSACTION_ID = t.ID and r.TYPE = 1) invoice,
			(SELECT c.COMPANY_NAME FROM t_company_info c WHERE c.ID = t.COMPANY_ID) companyName,
			t.SHIPPER_COMPANY_ID as shipperCompanyId,
			(select p.COMPANY_NAME from t_company_info p where p.ID = t.SHIPPER_COMPANY_ID) shipperCompanyName,
			t.SHIPPER_CODE_ID as shipperCodeId,
			(select p.COMPANY_NAME from t_company_info p where p.ID =
															   (select usr.COMPANY_ID from t_web_user_info usr where usr.ID = t.SHIPPER_CODE_ID)) shipperCodeName,
			t.RECEIVER_CODE_ID as receiverCodeId,
			(select p.COMPANY_NAME from t_company_info p where p.ID =
															   (select usr.COMPANY_ID from t_web_user_info usr where usr.ID = t.RECEIVER_CODE_ID)) receiverCodeName
		FROM
			t_transaction_info t,
			t_order_cargo_info t2
	   	WHERE
		   t.CARGO_ID = t2.ID and t.order_type = 2 and t.trade_start = 1 and
		   t.order_start = 0 and t.driver_id = #{driverId} and t.company_id = #{companyId}
	</select>

	<update id="batchUpdateTransactionStatue" parameterType="hashmap">
		update t_transaction_info set trade_start = #{tradeStart} WHERE id in
		<foreach collection="list" close=")" open="(" separator="," item="e" index="index">
			#{e}
		</foreach>
	</update>
</mapper>